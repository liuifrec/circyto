Metadata-Version: 2.4
Name: circyto
Version: 0.3.2
Summary: A Python CLI toolkit for single-cell circRNA detection, merging, and conversion.
Author: James Liu
License-Expression: MIT
Project-URL: Homepage, https://github.com/liuifrec/circyto
Project-URL: Issues, https://github.com/liuifrec/circyto/issues
Requires-Python: >=3.9
Description-Content-Type: text/markdown
Requires-Dist: typer<1.0,>=0.9
Requires-Dist: rich>=13.0
Requires-Dist: tqdm>=4.66
Requires-Dist: pandas>=2.0
Requires-Dist: numpy>=1.24
Requires-Dist: scipy>=1.10
Provides-Extra: loom
Requires-Dist: loompy>=3.0; extra == "loom"
Provides-Extra: h5ad
Requires-Dist: anndata>=0.9; extra == "h5ad"

# circCyto

<p align="center">
  <a href="https://github.com/liuifrec/circyto/releases">
    <img src="https://img.shields.io/github/v/release/liuifrec/circyto?display_name=tag&sort=semver&style=flat-square" />
  </a>
  <a href="https://github.com/liuifrec/circyto/issues">
    <img src="https://img.shields.io/github/issues/liuifrec/circyto?style=flat-square" />
  </a>
  <a href="https://github.com/liuifrec/circyto/blob/main/LICENSE">
    <img src="https://img.shields.io/github/license/liuifrec/circyto?style=flat-square" />
  </a>
  <img src="https://img.shields.io/badge/python-3.10%20|%203.11%20|%203.12-blue?style=flat-square" />
  <img src="https://img.shields.io/badge/PyPI-coming_soon-lightgrey?style=flat-square" />
</p>

<p align="center">
  <img src="assets/circCyto_logo.png" alt="circyto logo" width="420">
</p>

<p align="center">
  <b>circyto</b> â€” a modular CLI toolkit for single-cell circRNA detection,<br/>
  integrating multiple circRNA detectors into a unified sparse matrix workflow.
</p>

---

## Overview

`circyto` is a Python CLI framework to:

- run external circRNA detectors (CIRI-full, CIRI2, and future engines)
- normalize their outputs to a common circRNA schema
- assemble sparse circRNA Ã— cell matrices
- export results for Scanpy / Seurat / ML downstream analysis

Core ideas:

- **Detector-agnostic adapters**
- **Manifest-based reproducible job execution**
- **Sparse matrix output (MatrixMarket + AnnData)**
- **Multi-detector benchmarking** (v0.6.0+)

---

## âœ¨ Features (v0.8.0)

- ğŸ”§ **Single-detector runs**
  - `circyto run-detector` wraps individual engines:
    - **ciri-full** â€“ Java CIRI-full Pipeline via `ciri_full_adapter.sh`
    - **ciri2 (experimental)** â€“ standalone `CIRI2.pl` wrapper
  - Normalizes outputs to a shared TSV schema (`circ_id, chr, start, end, strand, support`)

- ğŸ§¬ **Manifest-based Smartâ€‘seq2 / 10x support**
  - `circyto prepare` converts 10x BAMs â†’ per-cell FASTQs
  - `circyto run-manifest` / `run` execute CIRI-full across many cells
  - `circyto collect` builds circRNA Ã— cell sparse matrices and feature tables

- ğŸ§  **Hostâ€‘gene aware multimodal export**
  - `circyto collect` writes `circ_feature_table.tsv`
  - `circyto annotate-host-genes` attaches host-gene columns via GTF
  - `circyto export-multimodal` integrates circRNA counts into an existing `.h5ad`
    - gene expression in `.X`
    - circRNA matrix in `obsm["X_circ"]`
    - circ feature + host map in `adata.uns["circ"]` / `adata.uns["circ_host_map"]`

- ğŸ”€ **Multi-detector orchestration (v0.6.0+)**
  - `circyto run-multidetector`: run several detectors on the same manifest
  - `circyto merge-detectors`: merge per-detector TSVs into union tables
  - `circyto compare-detectors`: compute Jaccard and summary stats across detectors

---

## ğŸ§ª Detector comparison

| Detector | Input type | Index / reference | Output granularity | Strengths | Limitations / Notes | circyto status |
|---------|------------|-------------------|--------------------|-----------|---------------------|----------------|
| **CIRI-full** | Paired-end FASTQ | Genome FASTA + BWA index + GTF | Full-length circRNA + AS | Full-length reconstruction, integrates RO/AS, detailed output | Heavy, multi-stage pipeline; needs good reference indices | âœ… Fully integrated (`prepare`/`run-manifest`/`run-detector` + `collect`) |
| **CIRI2** | Paired-end FASTQ | Genome FASTA + BWA index + GTF | Back-splice junctions | Simple, widely used C detector, good for benchmarking | Designed for bulk; some low-support sc calls still filtered even with relaxed settings | âš—ï¸ Experimental (`run-detector`, `run-multidetector`) |
| **CIRI-long** | Long-read FASTQ (ONT) | Genome FASTA + minimap2 index | Full-length circRNA | Tailored to long reads; captures complex isoforms | Long-read only; runtime/memory depend on read length | ğŸ”œ Planned |
| **CIRCexplorer2** | BAM (spliced alignments) | Genome FASTA + annotation | Back-splice junctions | Works from common alignment BAMs; widely cited | No full-length reconstruction; depends on upstream aligner | ğŸ”œ Planned |
| **find_circ** | FASTQ / BAM | Genome FASTA + BWA index | Back-splice junctions | Simple and fast; classic circRNA detector | Older; higher FP rate; no full-length info | ğŸ”œ Planned |

**Status legend**

- âœ… **Integrated** â€“ wired through CLI + adapters and tested on Smartâ€‘seq2 chr21
- âš—ï¸ **Experimental** â€“ useful but still under tuning for sparse scRNA-seq
- ğŸ”œ **Planned** â€“ API design in place, implementation not merged yet

---

## ğŸš€ Installation

```bash
git clone https://github.com/liuifrec/circyto.git
cd circyto
pip install -e .
```

Optional extras (future detector integrations, dev tooling):

```bash
pip install -e .[detectors]
```

---

## ğŸ•¹ï¸ CLI Commands

### Core pipeline

| Command | Description |
|--------|-------------|
| `circyto prepare` | 10x BAM â†’ FASTQs (`--chemistry tenx-3p|tenx-5p`) |
| `circyto run` | Run CIRI-full on batches produced by `prepare` |
| `circyto run-manifest` | Run CIRI-full using a manifest TSV (per-cell FASTQs) |
| `circyto collect` | Merge CIRI outputs into circ Ã— cell sparse matrix + `circ_feature_table.tsv` |
| `circyto annotate-host-genes` | Add host-gene columns to `circ_feature_table.tsv` using a GTF |
| `circyto export-multimodal` | Attach circRNA counts and metadata to an existing `.h5ad` |
| `circyto convert` | Convert `.mtx` + index files to `.loom` / `.h5ad` (legacy helper) |
| `circyto make` | All-in-one helper that detects manifest or BAM inputs and runs the pipeline |

### Detector engines (single-detector runs)

`circyto run-detector` runs one detector over a manifest, writing one normalized TSV per cell.

```bash
circyto run-detector ciri-full \
  --manifest manifest.tsv \
  --outdir work/ciri_full_chr21 \
  --ref-fa ref/chr21.fa \
  --gtf ref/chr21.gtf \
  --threads 8 \
  --parallel 4
```

```bash
circyto run-detector ciri2 \
  --manifest manifest.tsv \
  --outdir work/ciri2_chr21 \
  --ref-fa ref/chr21.fa \
  --gtf ref/chr21.gtf \
  --threads 8 \
  --parallel 4
```

Under the hood:

- **ciri-full** â†’ Java CIRI-full Pipeline via `tools/CIRI-full_v2.0/bin/ciri_full_adapter.sh`
- **ciri2** â†’ Perl `CIRI2.pl` via `tools/CIRI-full_v2.0/bin/ciri2_adapter.sh`, with relaxed stringency flags (`-0`) by default to retain low-support sc candidates where possible

Note: even with relaxed flags, CIRI2â€™s internal filters can still drop borderline single-cell candidates. This is expected behaviour and part of the cross-detector comparison story.

---

## ğŸ”€ Multi-detector workflow (v0.6.0+)

### 1. Run multiple detectors on the same manifest

```bash
circyto run-multidetector ciri-full ciri2 \
  --manifest manifest.tsv \
  --outdir work/multi \
  --ref-fa ref/chr21.fa \
  --gtf ref/chr21.gtf \
  --threads 8 \
  --parallel 1
```

Output layout:

```text
work/multi/
  â”œâ”€â”€ ciri-full/
  â”‚     â”œâ”€â”€ <cell>.tsv
  â”‚     â””â”€â”€ <run dirs + logs>
  â”œâ”€â”€ ciri2/
  â”‚     â”œâ”€â”€ <cell>.tsv
  â”‚     â””â”€â”€ <run dirs + logs>
  â””â”€â”€ summary.json
```

`summary.json` tracks which detectors ran and where their outputs live, e.g.:

```json
{
  "ciri-full": {
    "detector": "ciri-full",
    "n_cells": 2,
    "outdir": "work/multi/ciri-full"
  },
  "ciri2": {
    "detector": "ciri2",
    "n_cells": 2,
    "outdir": "work/multi/ciri2"
  }
}
```

### 2. Merge per-detector TSVs

```bash
circyto merge-detectors \
  --indir work/multi \
  --outdir work/multi_merged
```

This produces:

- `circ_union.tsv` â€“ union of all circRNAs with per-detector support, e.g.

  - `circ_id, chr, start, end, strand`
  - `ciri-full_total_support, ciri-full_n_cells`
  - `ciri2_total_support, ciri2_n_cells`
  - â€¦ for each detector

- `circ_by_detector.tsv` â€“ long-format table (`circ_id, detector, total_support, n_cells`)
- `metadata.json` â€“ detector list and basic counts

### 3. Compare detectors (Jaccard / summary metrics)

```bash
circyto compare-detectors \
  --indir work/multi_merged \
  --outdir work/multi_compare
```

Outputs:

- `jaccard.tsv` â€“ Jaccard index of presence/absence across detectors

  - 1.0 on the diagonal
  - 0â€“1 between detectors (`intersection / union` of circ sets)

- `detector_summary.tsv` â€“ per-detector statistics

  - `n_circ` â€“ number of circRNAs called
  - `total_support` â€“ sum of support counts
  - `total_cells` â€“ sum of cells contributing to each detectorâ€™s calls

- `compare_metadata.json` â€“ configuration + basic metadata

These files are designed to be read directly into Python/R for:
- sensitivity / specificity patterns by detector
- consensus circRNA sets
- downstream filtering before building final circ Ã— cell matrices

---

## ğŸ“š Getting started

More detailed examples (Smartâ€‘seq2 chr21 subset, multi-detector runs, multimodal AnnData export) are documented in:

- `docs/getting_started.md`
- `docs/multidetector.md`

---

## ğŸ“– Citation

If you use **circCyto / circyto** in your work, please cite:

> Liu, Y.-C. *et al.* **circCyto** â€” a modular toolkit for single-cell circRNA profiling and integration with scRNA-seq workflows.  
> *Manuscript in preparation, 2025.*

---

## ğŸ“œ License

MIT License Â© 2025 **Yuâ€‘Chen (James) Liu**
